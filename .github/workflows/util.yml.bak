name: report-to-testmo
on:
  workflow_call:
    inputs:
      runs_on:
        description: "runner label specifying instance running the job"
        type: string
        required: true 
      run_id:
        description: "run id provided by GHA"
        required: true
        type: string
      build_type:
        description: "build type: nightly or release"
        type: string
        required: true
      status:
        description: "test status to report to testmo"
        type: string
        required: true
      testmo_project_id:
        description: "testmo project id"
        type: string
        required: true

jobs:

  TESTMO:
    runs-on: ${{ inputs.runs_on }}

    steps:

      - id: report
        run: |
          echo "node: $(node -v)"
          echo "npm: $(npm -v)"
          echo "Installing testmo cli..."
          sudo npm install -g @testmo/testmo-cli    
          export TESTMO_TOKEN=${{ secrets.TESTMO_TEST_TOKEN }}
          TESTMO_URL="https://neuralmagic.testmo.net"
          todaytime=`date +%Y%m%d`
          NAME="${{ github.event.repository.name }} ${{ inputs.build_type }} ${todaytime} ${{ inputs.commit_id }} RunID${{ inputs.run_id }}"
          if [[ "${{ inputs.status }}" = "FAILED" ]]; then
              echo "${{ github.event.repository.name }} build failed"
              echo "<status>failed</status>" > result.xml
          else
              echo "<status>success</status>" > result.xml
              echo "${{ github.event.repository.name }} build success"
          fi
          testmo automation:run:submit \
                         --instance "${TESTMO_URL}" \
                         --project-id ${{ inputs.testmo_project_id }}
                         --name "${NAME}" \
                         --source "${{ github.event.repository.name }}" \
                         --results "result.xml"
